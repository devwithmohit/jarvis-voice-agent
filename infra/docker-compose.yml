version: "3.9"

services:
  # PostgreSQL - Primary data store for long-term memory and user data
  postgres:
    image: postgres:15-alpine
    container_name: voice-agent-postgres
    environment:
      POSTGRES_DB: voice_agent
      POSTGRES_USER: agent
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agent -d voice_agent"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - voice-agent-net

  # Redis - Short-term memory cache and pub/sub messaging
  redis:
    image: redis:7-alpine
    container_name: voice-agent-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - voice-agent-net

  # API Gateway - Main HTTP/WebSocket entry point (Python FastAPI)
  # Uncomment when service is implemented in Phase 2+
  # api-gateway:
  #   build:
  #     context: ../services/api-gateway
  #     dockerfile: ../../infra/docker/api-gateway.Dockerfile
  #   container_name: voice-agent-api-gateway
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     - DB_HOST=postgres
  #     - REDIS_HOST=redis
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - voice-agent-net

  # Memory Service - Memory management (Python)
  # Uncomment when service is implemented in Phase 2
  # memory-service:
  #   build:
  #     context: ../services/memory-service
  #     dockerfile: ../../infra/docker/memory-service.Dockerfile
  #   container_name: voice-agent-memory
  #   environment:
  #     - DB_HOST=postgres
  #     - REDIS_HOST=redis
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - voice-agent-net

  # Agent Core - Reasoning engine (Python)
  # Uncomment when service is implemented
  # agent-core:
  #   build:
  #     context: ../services/agent-core
  #     dockerfile: ../../infra/docker/agent-core.Dockerfile
  #   container_name: voice-agent-core
  #   environment:
  #     - REDIS_HOST=redis
  #     - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
  #   depends_on:
  #     - memory-service
  #   networks:
  #     - voice-agent-net

  # STT Service - Speech-to-Text (Python + Whisper)
  stt-service:
    build:
      context: ../services/stt-service
      dockerfile: Dockerfile
    container_name: voice-agent-stt
    ports:
      - "50052:50052"
    volumes:
      - stt_models:/app/models # Mount for Whisper model cache
    environment:
      - WHISPER_MODEL=base.en
      - DEVICE=cpu
      - COMPUTE_TYPE=int8
      - GRPC_PORT=50052
      - GRPC_HOST=0.0.0.0
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import grpc; channel = grpc.insecure_channel('localhost:50052'); channel.close()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - voice-agent-net

  # TTS Service - Text-to-Speech (Python + Coqui TTS)
  tts-service:
    build:
      context: ../services/tts-service
      dockerfile: Dockerfile
    container_name: voice-agent-tts
    ports:
      - "50053:50053"
    volumes:
      - tts_models:/app/models # Mount for TTS model cache
    depends_on:
      - redis
    environment:
      - TTS_ENGINE=coqui
      - COQUI_MODEL=tts_models/en/ljspeech/tacotron2-DDC
      - USE_GPU=false
      - ENABLE_CACHE=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=2
      - GRPC_PORT=50053
      - GRPC_HOST=0.0.0.0
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import grpc; channel = grpc.insecure_channel('localhost:50053'); channel.close()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - voice-agent-net

  # Voice Gateway - Audio streaming & wake-word (Rust)
  voice-gateway:
    build:
      context: ../services/voice-gateway
      dockerfile: Dockerfile
    container_name: voice-agent-voice-gateway
    ports:
      - "50054:50054"
    volumes:
      - ./keywords:/app/keywords # Wake-word model files
    devices:
      - /dev/snd:/dev/snd # Audio device access (Linux)
    environment:
      - KEYWORD_PATH=/app/keywords/jarvis.ppn
      - SENSITIVITY=0.5
    depends_on:
      - stt-service
      - tts-service
    networks:
      - voice-agent-net

  # Tool Executor - Sandboxed tool execution (Rust)
  # Uncomment when service is implemented
  # tool-executor:
  #   build:
  #     context: ../services/tool-executor
  #     dockerfile: ../../infra/docker/tool-executor.Dockerfile
  #   container_name: voice-agent-tool-executor
  #   security_opt:
  #     - no-new-privileges:true
  #   cap_drop:
  #     - ALL
  #   cap_add:
  #     - NET_BIND_SERVICE
  #   networks:
  #     - voice-agent-net

  # Web Service - Browser automation (Python + Playwright)
  # Uncomment when service is implemented
  # web-service:
  #   build:
  #     context: ../services/web-service
  #     dockerfile: ../../infra/docker/web-service.Dockerfile
  #   container_name: voice-agent-web
  #   environment:
  #     - SERPAPI_KEY=${SERPAPI_KEY}
  #   networks:
  #     - voice-agent-net

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  stt_models:
    driver: local
  tts_models:
    driver: local

networks:
  voice-agent-net:
    driver: bridge
